import json
import os
from langchain_google_genai import ChatGoogleGenerativeAI
from dotenv import load_dotenv

load_dotenv()

def generate_exploit_plan():
    # 1. Load the "Training Data" (The Artifact)
    if not os.path.exists("rl_training_data.json"):
        print("No training data found. Run the QA Agent first.")
        return

    with open("rl_training_data.json", "r") as f:
        trajectory = json.load(f)

    # 2. Filter for "Interesting" States (High Reward)
    vulnerabilities = [t for t in trajectory if t["reward"] >= 0.5]

    if not vulnerabilities:
        print("No vulnerabilities found in the training run.")
        return

    print(f"Found {len(vulnerabilities)} potential vulnerability points.")

    # 3. Formulate the Plan using Gemini
    model = ChatGoogleGenerativeAI(
        model="gemini-1.5-pro",
        api_key=os.getenv("GOOGLE_API_KEY"),
        temperature=0.2
    )

    for vuln in vulnerabilities:
        target = vuln.get("target", {})
        
        prompt = f"""
        You are an Elite Penetration Tester. 
        
        We previously ran a fuzzing scan and found a vulnerability (Reward: {vuln['reward']}).
        
        VULNERABLE ELEMENT:
        - Tag: {target.get('tagName')}
        - ID: {target.get('id')}
        - Name: {target.get('name')}
        - HTML Context: {target.get('outerHTML')}
        
        ACTION THAT TRIGGERED IT:
        - Action Type: {vuln['action']}
        - Logs: {vuln['log']}
        - Reason for Detection: {vuln['reason']}
        
        YOUR TASK:
        Write a specific PLAYWRIGHT SCRIPT snippet to exploit this specific element.
        If it was an input, suggest an SQL Injection or XSS payload.
        If it was a crash, suggest a DoS payload.
        
        Return code only.
        """

        print(f"\n--- Generating Exploit for {target.get('id', 'unknown')} ---")
        res = model.invoke(prompt)
        print(res.content)
        print("-" * 40)

if __name__ == "__main__":
    generate_exploit_plan()